### Shopping Cart API - Manual Tests
### Use with REST Client extension in VS Code
###
### ğŸ“Š Visualize data:
### - Firebase Emulator UI: http://localhost:4000/database/demo-project/data
### - PubSub UI: http://localhost:4001

@baseUrl = http://localhost:3000
@clientId = test-client-1
@tokenWriter = token-writer
@tokenAdmin = token-admin

### Add product item to cart
# ğŸ“ Action: Creates ProductItemAddedToShoppingCart event and stores it in Firestore
# ğŸ” Firebase UI (http://localhost:4000/database/demo-project/data):
#    - Check: projections/shoppingCartDetails/shopping_cart:test-client-1:current
#      Shows complete cart with: clientId, productItems[], status, totalAmount
#    - Check: projections/shoppingCartShortInfo/shopping_cart:test-client-1:current
#      Shows summary: productItemsCount, totalAmount
# ğŸ“¨ PubSub UI (http://localhost:4001):
#    - No messages yet (only confirmation events are published to PubSub)
POST {{baseUrl}}/clients/{{clientId}}/shopping-carts/current/product-items
Authorization: Bearer {{tokenWriter}}
Content-Type: application/json

{
  "productId": "product-1",
  "quantity": 2
}

### Add another product (to SAME cart)
# ğŸ“ Action: Adds second product and updates both projections
# ğŸ” Firebase UI (http://localhost:4000/database/demo-project/data):
#    - Projections updated with new product and totals
#    - productItemsCount: 3 (2 + 1)
#    - totalAmount: 300 (2*100 + 1*100)
# ğŸ“¨ PubSub UI (http://localhost:4001):
#    - Still no messages (only confirmation publishes to PubSub)
POST {{baseUrl}}/clients/{{clientId}}/shopping-carts/current/product-items
Authorization: Bearer {{tokenWriter}}
Content-Type: application/json

{
  "productId": "product-2",
  "quantity": 1
}

### Get shopping cart details (READ from Realtime DB - Details projection)
# ğŸ“ Action: Reads shoppingCartDetails projection from Realtime Database
# ğŸ” Firebase UI: Same projection visible at projections/shoppingCartDetails/...
# ğŸ“¨ PubSub UI: No messages
GET {{baseUrl}}/clients/{{clientId}}/shopping-carts/current
Authorization: Bearer {{tokenAdmin}}

### Get shopping cart summary (READ from Realtime DB - ShortInfo projection)
# ğŸ“ Action: Reads shoppingCartShortInfo projection from Realtime Database
# ğŸ” Firebase UI: Same projection visible at projections/shoppingCartShortInfo/...
# ğŸ“¨ PubSub UI: No messages
GET {{baseUrl}}/clients/{{clientId}}/shopping-carts/current/summary
Authorization: Bearer {{tokenAdmin}}

### Remove product item from cart
# ğŸ“ Action: Creates ProductItemRemovedFromShoppingCart event and updates projections
# ğŸ” Firebase UI (http://localhost:4000/database/demo-project/data):
#    - Projections updated: product-1 quantity reduced or removed
#    - Totals recalculated
# ğŸ“¨ PubSub UI (http://localhost:4001):
#    - No messages (removal doesn't publish to PubSub)
DELETE {{baseUrl}}/clients/{{clientId}}/shopping-carts/current/product-items?productId=product-1&quantity=1&unitPrice=100
Authorization: Bearer {{tokenWriter}}

### Confirm cart
# ğŸ“ Action: Confirms cart, PUBLISHES ShoppingCartConfirmed message, and DELETES projections
# ğŸ” Firebase UI (http://localhost:4000/database/demo-project/data):
#    - BOTH projections will be REMOVED (deleted after confirmation)
#    - Navigate to: projections/shoppingCartDetails/ and projections/shoppingCartShortInfo/
#    - The cart shopping_cart:test-client-1:current should disappear
# ğŸ“¨ PubSub UI (http://localhost:4001):
#    - â­ CHECK TOPIC: "shopping-cart-evt-ShoppingCartConfirmed"
#    - A new message should appear with cart details
#    - Message will be VISIBLE because app is in producer-only mode (no consumers)
POST {{baseUrl}}/clients/{{clientId}}/shopping-carts/current/confirm
Authorization: Bearer {{tokenWriter}}

### Try to get confirmed cart (should return 404 - projection deleted)
# ğŸ“ Action: Attempts to read deleted projection
# ğŸ” Firebase UI: Projection no longer exists (was deleted on confirmation)
# ğŸ“¨ PubSub UI: No new messages
# âš ï¸  Expected: 404 Not Found
GET {{baseUrl}}/clients/{{clientId}}/shopping-carts/current
Authorization: Bearer {{tokenAdmin}}

### Try to get summary of confirmed cart (should return 404 - projection deleted)
# ğŸ“ Action: Attempts to read deleted projection
# ğŸ” Firebase UI: Projection no longer exists
# ğŸ“¨ PubSub UI: No new messages
# âš ï¸  Expected: 404 Not Found
GET {{baseUrl}}/clients/{{clientId}}/shopping-carts/current/summary
Authorization: Bearer {{tokenAdmin}}

### Try to add to confirmed cart (should fail)
# ğŸ“ Action: Attempts to add product to confirmed cart
# ğŸ” Firebase UI: No changes (operation should fail)
# ğŸ“¨ PubSub UI: No new messages
# âš ï¸  Expected: Error (cannot modify confirmed cart)
POST {{baseUrl}}/clients/{{clientId}}/shopping-carts/current/product-items
Authorization: Bearer {{tokenWriter}}
Content-Type: application/json

{
  "productId": "product-3",
  "quantity": 1
}

### New cart for different client
# ğŸ“ Action: Creates new cart for "another-client"
# ğŸ” Firebase UI (http://localhost:4000/database/demo-project/data):
#    - New projections appear:
#      * projections/shoppingCartDetails/shopping_cart:another-client:current
#      * projections/shoppingCartShortInfo/shopping_cart:another-client:current
# ğŸ“¨ PubSub UI (http://localhost:4001):
#    - No new messages
POST {{baseUrl}}/clients/another-client/shopping-carts/current/product-items
Authorization: Bearer {{tokenWriter}}
Content-Type: application/json

{
  "productId": "product-3",
  "quantity": 5
}

### Get details for another-client cart
# ğŸ“ Action: Reads another-client cart details projection
# ğŸ” Firebase UI: Shows data at projections/shoppingCartDetails/shopping_cart:another-client:current
# ğŸ“¨ PubSub UI: No messages
GET {{baseUrl}}/clients/another-client/shopping-carts/current
Authorization: Bearer {{tokenAdmin}}

### Get summary for another-client cart
# ğŸ“ Action: Reads another-client cart summary projection
# ğŸ” Firebase UI: Shows data at projections/shoppingCartShortInfo/shopping_cart:another-client:current
# ğŸ“¨ PubSub UI: No messages
GET {{baseUrl}}/clients/another-client/shopping-carts/current/summary
Authorization: Bearer {{tokenAdmin}}

### Cancel cart
# ğŸ“ Action: Cancels cart and DELETES projections (no PubSub message)
# ğŸ” Firebase UI (http://localhost:4000/database/demo-project/data):
#    - BOTH projections for another-client cart will be REMOVED
# ğŸ“¨ PubSub UI (http://localhost:4001):
#    - No new messages (cancellation doesn't publish to PubSub)
DELETE {{baseUrl}}/clients/another-client/shopping-carts/current
Authorization: Bearer {{tokenWriter}}
